<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Error Testing - Garp</title>
    <link href="/style.css" rel="stylesheet">
    <link href="/search-styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container-garp py-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-6">Search Error Testing</h1>
        
        <div class="grid gap-6">
            <!-- Normal Search -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Normal Search (Control)</h2>
                <div id="search-normal"></div>
            </div>

            <!-- Test Missing Search Assets -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Test: Missing Search Assets</h2>
                <p class="text-gray-600 mb-4">This search will try to load from a non-existent path to test error handling.</p>
                <div id="search-missing"></div>
            </div>

            <!-- Test Network Error Handling -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Test: Custom Error Scenarios</h2>
                <div class="space-y-4">
                    <button onclick="testLongQuery()" class="btn btn-primary">Test Very Long Query</button>
                    <button onclick="testSpecialChars()" class="btn btn-primary">Test Special Characters</button>
                    <button onclick="testEmptyQuery()" class="btn btn-primary">Test Empty Query</button>
                    <button onclick="testJSError()" class="btn btn-secondary">Test JS Error (intentional)</button>
                </div>
                <div id="test-results" class="mt-4 p-4 bg-gray-100 rounded hidden">
                    <h3 class="font-semibold mb-2">Test Results:</h3>
                    <ul id="results-list" class="space-y-1 text-sm"></ul>
                </div>
            </div>

            <!-- Performance Test -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Performance Testing</h2>
                <p class="text-gray-600 mb-4">Test search response times and performance.</p>
                <button onclick="performanceTest()" class="btn btn-primary">Run Performance Test</button>
                <div id="performance-results" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Performance Results:</h3>
                    <div id="perf-data" class="text-sm space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Normal Pagefind Search -->
    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js"></script>

    <script>
        // Initialize normal search
        window.addEventListener('DOMContentLoaded', () => {
            try {
                new PagefindUI({ 
                    element: "#search-normal",
                    showSubResults: true,
                    showImages: false,
                    excerptLength: 30,
                    resetStyles: false
                });
                logResult("✓ Normal search initialized successfully");
            } catch (error) {
                logResult("✗ Failed to initialize normal search: " + error.message);
            }

            // Try to initialize search with bad path (should fail gracefully)
            try {
                new PagefindUI({ 
                    element: "#search-missing",
                    basePath: "/nonexistent-pagefind/",
                    showSubResults: true,
                    showImages: false,
                    excerptLength: 30,
                    resetStyles: false
                });
                logResult("? Missing path search initialized (unexpected)");
            } catch (error) {
                logResult("✓ Missing path search failed gracefully: " + error.message);
            }
        });

        function logResult(message) {
            const resultsDiv = document.getElementById('test-results');
            const resultsList = document.getElementById('results-list');
            resultsDiv.classList.remove('hidden');
            
            const li = document.createElement('li');
            li.textContent = message;
            li.className = message.startsWith('✓') ? 'text-green-600' : 
                           message.startsWith('✗') ? 'text-red-600' : 'text-yellow-600';
            resultsList.appendChild(li);
        }

        function testLongQuery() {
            const longQuery = "a".repeat(1000); // 1000 character query
            const searchInput = document.querySelector('#search-normal input');
            if (searchInput) {
                searchInput.value = longQuery;
                searchInput.dispatchEvent(new Event('input'));
                logResult("✓ Long query test completed (1000 chars)");
            } else {
                logResult("✗ Could not find search input for long query test");
            }
        }

        function testSpecialChars() {
            const specialQuery = '!@#$%^&*()[]{}|\\:";\'<>?,./`~';
            const searchInput = document.querySelector('#search-normal input');
            if (searchInput) {
                searchInput.value = specialQuery;
                searchInput.dispatchEvent(new Event('input'));
                logResult("✓ Special characters test completed");
            } else {
                logResult("✗ Could not find search input for special chars test");
            }
        }

        function testEmptyQuery() {
            const searchInput = document.querySelector('#search-normal input');
            if (searchInput) {
                searchInput.value = "";
                searchInput.dispatchEvent(new Event('input'));
                logResult("✓ Empty query test completed");
            } else {
                logResult("✗ Could not find search input for empty query test");
            }
        }

        function testJSError() {
            try {
                // Intentionally cause an error
                nonExistentFunction();
            } catch (error) {
                logResult("✓ JS error handled: " + error.message);
            }
        }

        async function performanceTest() {
            const performanceDiv = document.getElementById('performance-results');
            const perfData = document.getElementById('perf-data');
            performanceDiv.classList.remove('hidden');
            perfData.innerHTML = '';

            const testQueries = [
                "getting started",
                "tailwind css",
                "cli reference",
                "pagefind search",
                "garp serve development server"
            ];

            let totalTime = 0;
            let testCount = 0;

            for (const query of testQueries) {
                const startTime = performance.now();
                
                // Simulate search by setting input value
                const searchInput = document.querySelector('#search-normal input');
                if (searchInput) {
                    searchInput.value = query;
                    searchInput.dispatchEvent(new Event('input'));
                    
                    // Wait for search to process
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    totalTime += duration;
                    testCount++;
                    
                    const resultDiv = document.createElement('div');
                    resultDiv.innerHTML = `Query "${query}": ${duration.toFixed(2)}ms`;
                    resultDiv.className = duration < 500 ? 'text-green-600' : 
                                        duration < 1000 ? 'text-yellow-600' : 'text-red-600';
                    perfData.appendChild(resultDiv);
                }
            }

            const avgTime = totalTime / testCount;
            const summaryDiv = document.createElement('div');
            summaryDiv.innerHTML = `<strong>Average response time: ${avgTime.toFixed(2)}ms</strong>`;
            summaryDiv.className = avgTime < 500 ? 'text-green-600 mt-2' : 
                                 avgTime < 1000 ? 'text-yellow-600 mt-2' : 'text-red-600 mt-2';
            perfData.appendChild(summaryDiv);

            logResult(`✓ Performance test completed - Avg: ${avgTime.toFixed(2)}ms`);
        }

        // Monitor for console errors
        window.addEventListener('error', (event) => {
            logResult("✗ JavaScript error detected: " + event.message);
        });

        // Monitor for unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            logResult("✗ Unhandled promise rejection: " + event.reason);
        });
    </script>
</body>
</html>